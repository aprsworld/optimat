o<toolchange> sub

; TODO: put away tool before getting next one

; load tool
; tools 0 through 6 are from ATC carousel and go into the main spindle
; tools >6 are individually activated

O10 IF [#<selected_tool> LE 6]
; we need to do these nets to LinuxCNC knows we are done, I guess
; net tool-prep-loop iocontrol.0.tool-prepare iocontrol.0.tool-prepared
; net tool-change-loop iocontrol.0.tool-change iocontrol.0.tool-changed

; stub turn laser on 
M64 P20

; TODO: make sure optimat_i_router_1_standstill


; from page 5.5.4 of manual
; [FROM MANUAL] main spindle is set pneumatically into the lower position


; prepare carousel 

; M68 E3 Q10.0 ; debug

; make sure arm is in basic position
M65 P2 ; turn off changing position
M64 P3 ; turn on basic position

; make sure router is down
M65 P6 ; turn off units up
M64 P5 ; turn on router down
; wait until router is on bottom
M66 P4 L3 Q4
O102 if [#5399 LT 0]
	(abort, failed to get router pneumatically down)
O102 endif

; bring z-axis to tool change position (+0.500)
G53 G0 Z0.500


; bring plate down so we can rotate it
; M65 P1 ; turn off magazine up
; M64 P0 ; turn on magazine down .... this one physically sticks
; wait until tool magazine on bottom is high or 10 seconds
; M66 P6 L3 Q10
; O104 if [#5399 LT 0]
; 	(abort, failed to get magazine down)
; O104 endif



; tell the carousel module go to position for tool currently in spindle
; M68 E0 Q#<tool_in_spindle>
; M68 E0 Q#<selected_tool>
; G4 P0.1
; turn on enable to make it go
; M64 P7
; wait until ready or 10 seconds
; M66 P10 L3 Q10
; O114 if [#5399 LT 0]
; 	(abort, carousel never got ready)
; O114 endif
; wait until not active or 10 seconds
; M66 P11 L4 Q10
; O124 if [#5399 LT 0]
; 	(abort, carousel never finished being active)
; O124 endif
; turn off enable
; M65 P7


; bring plate up
M65 P0 ; turn off magazine down
M64 P1 ; turn on magazine up
; wait until tool magazine on top is high or 5 seconds
M66 P7 L3 Q5
O134 if [#5399 LT 0]
	(abort, failed to get magazine up)
O134 endif

; move arm to tool change position
M65 P3 ; turn off basic position
M64 P2 ; turn on changing position
; make sure we got to changing position
M66 P8 L3 Q4
O136 if [#5399 LT 0]
	(abort, failed to get magazine to changing position)
	; this is where we died
O136 endif

; release tool from spindle
M64 P4 ; open clamp
; make sure we are unclamped
M66 P1 L3 Q2
O144 if [#5399 LT 0]
	(abort, failed to unclamp)
O144 endif

; send plate down and pull tool out of spindle
M65 P1 ; turn off magazine up
M64 P0 ; turn on magazine down
; wait until plate is down or 5 seconds
M66 P6 L3 Q5
O154 if [#5399 LT 0]
	(abort, failed to get magazine down)
O154 endif

; tell the carousel module go to position for tool to put in spindle
M68 E0 Q#<selected_tool>
G4 P0.1
; turn on enable to make it go
M64 P7
; wait until ready or 10 seconds
M66 P10 L3 Q10
O164 if [#5399 LT 0]
	(abort, carousel never got ready)
O164 endif
; wait until not active or 10 seconds
M66 P11 L4 Q10
O166 if [#5399 LT 0]
	(abort, carousel never finished being active)
O166 endif
; turn off enable
M65 P7

; bring plate up
M65 P0 ; turn off magazine down
M64 P1 ; turn on magazine up
; wait until tool magazine on top is high or 5 seconds
M66 P7 L3 Q5
O174 if [#5399 LT 0]
	(abort, failed to get magazine up)
O174 endif

; clamp tool
M65 P4 ; close clamp
; make sure we are clamped
M66 P0 L3 Q2
O184 if [#5399 LT 0]
	(abort, failed to clamp)
O184 endif

; retract tool changer arm
M65 P2 ; turn off changing position
M64 P3 ; turn on basic position
; make sure we got to basic position
M66 P9 L3 Q4
O194 if [#5399 LT 0]
	(abort, failed to get magazine to basic position)
O194 endif




; stub turn laser off
M65 P20


; [FROM MANUAL] afterwards the z-axis moves to the change position

; [FROM MANUAL] the changer case moves to the preparing position
; [FROM MANUAL] doing this, the empty tool holding grip snap into the ring groove
; [FROM MANUAL] of the HSK holder which is the main spindle

; [FROM MANUAL] tool is released in the spindle

; [FROM MANUAL] the magazine plate will be pneumatically lowered onto the changing 
; [FROM MANUAL] position and draw the tool out of the cone

; [FROM MANUAL] the magazine plate turns the tool which has to be inserted
; [FROM MANUAL] under the main spindle

; [FROM MANUAL] the magazine plate will be removed into the initial position and insert
; [FROM MANUAL] the new tool into the spindle

; [FROM MANUAL] the pneumatic cylinder of the changer case removes into the initial position

; [FROM MANUAL] done

O10 ELSEIF [#<selected_tool> EQ 7]
M64 P20 ; turn on laser crosshair

O10 ELSEIF [#<selected_tool> EQ 8]
M64 P9 ; turn on spindle 1

O10 ELSEIF [#<selected_tool> EQ 9]
M64 P10 ; turn on spindle 2

O10 ENDIF




; O200 IF [#<selected_tool> GT 0]



; o<toolchange> endsub [1]
o<toolchange> endsub [2.0]
M2
